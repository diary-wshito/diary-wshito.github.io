<!DOCTYPE html>
<html lang="ja-JP">

<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  
    
        <meta name="twitter:card" content="summary"/>
    



<meta name="twitter:title" content="コードリーディング: Lack の Session ミドルウェアを理解する"/>
<meta name="twitter:description" content=""/>
<meta name="twitter:site" content="@waterloo_jp"/>



  <meta property="og:title" content="コードリーディング: Lack の Session ミドルウェアを理解する &middot; wshito&#39;s diary" />
  <meta property="og:site_name" content="wshito&#39;s diary" />
  <meta property="og:url" content="http://diary.wshito.com/comp/lisp/clack/lack-middleware-session/" />

  
  
  

  
  <meta property="og:description" content="" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2018-02-07T15:36:34&#43;09:00" />

  
  <meta property="article:tag" content="lisp" />
  
  <meta property="article:tag" content="clack" />
  
  <meta property="article:tag" content="lack" />
  
  <meta property="article:tag" content="webapp" />
  
  

  <title>コードリーディング: Lack の Session ミドルウェアを理解する &middot; wshito&#39;s diary</title>

  
  <meta name="description" content="Webアプリケーションを構築する際にはユーザのセッション管理が必須である．今回は lack-middleware-session のソースを読みながらSessionミドルウェアの使い方を学ぶ．本稿の最後ではSessionミドルウェアを使ったサンプルWebアプリケーションを構築する． Sessionミドルウェアの概観 S" />
  

  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="shortcut icon" href="http://diary.wshito.com/images/favicon.ico">
  <link rel="apple-touch-icon" href="http://diary.wshito.com/images/apple-touch-icon.png" />

  <link rel="stylesheet" type="text/css" href="http://diary.wshito.com/css/screen.css" />
  <link rel="stylesheet" type="text/css"
    href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
  <link rel="stylesheet" type="text/css" href="http://diary.wshito.com/css/prism.css">
  <link rel="stylesheet" type="text/css" href="http://diary.wshito.com/css/wshito-casper.css">

  

  
  
  <link href="http://diary.wshito.com/index.xml" rel="alternate" type="application/rss+xml" title="wshito&#39;s diary" />
  
  
  
  <meta name="generator" content="Hugo 0.81.0" />

  <link rel="canonical" href="http://diary.wshito.com/comp/lisp/clack/lack-middleware-session/" />

  
  
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "W.Shito"
    },
    "author": {
        "@type": "Person",
        "name": "W.Shito",
        
        "url": "http://diary.wshito.com",
        "sameAs": [
            
            
             
             
             
             
             
            
        ]
    },
    "headline": "コードリーディング: Lack の Session ミドルウェアを理解する",
    "name": "コードリーディング: Lack の Session ミドルウェアを理解する",
    "wordCount":  11198 ,
    "timeRequired": "PT23M",
    "inLanguage": {
      "@type": "Language",
      "alternateName": "en"
    },
    "url": "http://diary.wshito.com/comp/lisp/clack/lack-middleware-session/",
    "datePublished": "2018-02-07T15:36Z",
    "dateModified": "2018-02-07T15:36Z",
    
    "keywords": "lisp, clack, lack, webapp",
    "description": "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://diary.wshito.com/comp/lisp/clack/lack-middleware-session/"
    }
}
    </script>
    


  

  
  
  <script>
    (function (i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function () {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-422028-3', 'auto');
    ga('send', 'pageview');
  </script>
  
  


  

  
  <script src="https://kit.fontawesome.com/7c5784892e.js" crossorigin="anonymous"></script>
  
</head>

<body class="post-template nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        
        
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://diary.wshito.com/">Home</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://diary.wshito.com/categories/">Categories</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="http://diary.wshito.com/tags/">Tags</a>
            </li>
        
        
    </ul>

    
    <a class="subscribe-button icon-feed" href="http://diary.wshito.com/index.xml">Subscribe</a>
    
</div>
<span class="nav-cover"></span>


  <div class="site-wrapper">

    
          <header class="main-header post-head no-cover">
            <nav class="main-nav clearfix">
              

              
              
              <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">Menu</span></a>
              
            </nav>
          </header>


          <main class="content" role="main">

            

            <article class="post comp">

              <header class="post-header">
                <h1 class="post-title">コードリーディング: Lack の Session ミドルウェアを理解する</h1>
                
                <section class="post-meta">
                  <time class="post-date" datetime="2018-02-07T15:36:34&#43;09:00">
                    February 7, 2018
                  </time>
                  
                  on
                  
                  
                  <span class="post-tag small"><a href="http://diary.wshito.com//tags/lisp/">#lisp</a></span>
                  
                  <span class="post-tag small"><a href="http://diary.wshito.com//tags/clack/">#clack</a></span>
                  
                  <span class="post-tag small"><a href="http://diary.wshito.com//tags/lack/">#lack</a></span>
                  
                  <span class="post-tag small"><a href="http://diary.wshito.com//tags/webapp/">#webapp</a></span>
                  
                </section>
              </header>

              <section class="post-content">
                
                目次
                <nav id="TableOfContents"></nav>
                
                <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Webアプリケーションを構築する際にはユーザのセッション管理が必須である．今回は <a href="https://github.com/fukamachi/lack/blob/master/src/middleware/session.lisp">lack-middleware-session</a> のソースを読みながらSessionミドルウェアの使い方を学ぶ．<a href="#sec:sample">本稿の最後</a>ではSessionミドルウェアを使ったサンプルWebアプリケーションを構築する．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessionミドルウェアの概観">Sessionミドルウェアの概観</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sessionミドルウェアはセッション変数として，文字列をキーにしたハッシュテーブルを提供する．つまり，セッション毎にハッシュテーブルが用意される．Webアプリケーションは任意のセッション情報をこのセッション変数（ハッシュテーブル）に格納することができる．</p>
</div>
<div class="paragraph">
<p>各セッションはセッションIDによって識別される．新規セッションが開始されると，セッションIDとセッション変数（ハッシュテーブル）が生成され，サーバー側の <code>store</code> バックエンドに保存される．一方，クライアント側ではセッションIDがブラウザ・クッキーに保存される．Sessionミドルウェアはクッキーに保存されたセッションIDを用いてクライアントを識別する．</p>
</div>
<div class="paragraph">
<p>セッション変数の保存先である <code>store</code> バックエンドのデフォルトは，インメモリのハッシュテーブル（キーがセッションIDで値がセッション変数）である．したがって，セッション変数も <code>store</code> バックエンドもハッシュテーブルである．<code>store</code> バックエンドはオプションでRedisとSQLデータベースを指定できる．</p>
</div>
<div class="paragraph">
<p>リクエストがあるとSessionミドルウェアはクッキーからセッションIDを取り出し，セッション変数（ハッシュテーブル）を <code>store</code> バックエンドから取り出す．</p>
</div>
<div class="paragraph">
<p>セッション変数を使うには，Sessionミドルウェアより後のパイプラインにあるアプリケーションで</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(getf env :lack.session)</code></pre>
</div>
</div>
<div class="paragraph">
<p>を実行し <code>env</code> からセッション変数（ハッシュテーブル）を取り出す．取り出したハッシュテーブルに，任意のキー・バリューを保存することができる．セッション変数は，パイプライン後方のアプリケーションを実行した後，Sessionミドルウェアの事後処理で自動的にバックエンドに保存される．</p>
</div>
<div class="paragraph">
<p>以下，コードを追いながら細かい設定事項と動作の詳細を見ていく．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessionミドルウェアの引数">Sessionミドルウェアの引数</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session.lisp#L20">Sessionミドルウェア</a> はアプリケーション・ビルド時に3つのキーワード引数，<code>:store</code>，<code>:state</code>，<code>:keep-empty</code> をとる．</p>
</div>
<div id="listings:session-middleware-1" class="listingblock">
<div class="title">コード 1. Sessionミドルウェアの引数</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(lambda (app &amp;key
            (store (make-memory-store))
            (state (make-cookie-state))
            (keep-empty t))
    (lambda (env)
    ...
    ミドルウェア本体
    ...
    ))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>:store</code> キーワードでセッション変数の格納場所を指定する．デフォルトの格納先はメモリ上のハッシュテーブルである．ちなみに <code>store</code> に保存されるセッション変数自体もハッシュテーブルである．</p>
</div>
<div class="paragraph">
<p><code>:state</code> キーワードには，セッションIDとセッション状態を管理する <code>state</code> 構造体インスタンスを指定する．デフォルトでは <code>cookie-state</code> 構造体インスタンスが使われる．クッキーの設定を変更したい場合は，属性をカスタム設定したインスタンスを指定する．</p>
</div>
<div class="paragraph">
<p><code>:keep-empty</code> キーワードが <code>t</code> の場合，セッション情報が <code>store</code> バックエンドに保存される．</p>
</div>
<div class="paragraph">
<p><a href="#listings:session-middleware-1">コード 1</a>の2—​4行目は，Webアプリケーション構築時に1回だけ実行される．したがって，セッションを管理する <code>store</code> もクッキーの雛形になる <code>state</code> も，全てのリクエストで共有される．</p>
</div>
<div class="sect2">
<h3 id="_セッション保存方法の設定">セッション保存方法の設定</h3>
<div class="paragraph">
<p><a href="#listings:session-middleware-1">コード 1</a>の2行目，<code>store</code> のデフォルト値は <code>memory-store</code> 構造体インスタンスである．<code>memory-store</code> 構造体は <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session/store/memory.lisp#L13"> <code>src/middleware/seesion/store/memory.lisp</code> </a> で以下のように定義されている．</p>
</div>
<div class="listingblock">
<div class="title">コード 2. <code>memory-store</code> 構造体の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defstruct (memory-store (:include store))
  (stash (make-hash-table :test &#39;equal)))			<i class="conum" data-value="1"></i><b>(1)</b>

(defmethod fetch-session ((store memory-store) sid)
  (gethash sid (memory-store-stash store)))

(defmethod store-session ((store memory-store) sid session)
  (setf (gethash sid (memory-store-stash store))		<i class="conum" data-value="2"></i><b>(2)</b>
        session))

(defmethod remove-session ((store memory-store) sid)
  (remhash sid (memory-store-stash store)))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>stash</code> スロットにセッション変数を格納するハッシュテーブルを用意．キーは文字列から成るセッションIDなので，テスト関数は <code>equal</code> を指定している．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>セッションIDをキーとしてセッション変数を保存する．保存されるセッション変数も文字列をキーとしたハッシュテーブルである．<code>memory-store-stash</code> は <code>stash</code> スロットへのアクセサ関数で <code>defstruct</code> 時に自動的に定義される．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>memory-store</code> 構造体は，<code>stash</code> スロットの初期値として，文字列キーで比較するハッシュテーブルを設定する．<code>memory-store</code> が継承する <code>store</code> 構造体はスロットのない抽象構造で <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session/store.lisp#L11"> <code>src/middleware/session/store.lisp</code> </a> で以下のように定義されている．</p>
</div>
<div class="listingblock">
<div class="title">コード 3. <code>store</code> 構造体の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defstruct store)

(defgeneric fetch-session (store sid))
(defgeneric store-session (store sid session))
(defgeneric remove-session (store sid))</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>store</code> 構造体はセッション変数を格納するバックエンド用に3つの抽象インターフェースを定義する．Sessionミドルウェアはこれら3つの総称関数を用いて，ユーザが <code>:store</code> キーワードで指定した <code>store</code> インスタンスに対し，セッションIDの取り出し，保存，削除を行う．ちなみに，Lackにはインメモリのバックエンドに加え，Redis用の <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session/store/redis.lisp#L27"> <code>redis-store</code> </a> と SQLデータベース用の <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session/store/dbi.lisp#L22"> <code>dbi-store</code> </a> がオプションとして用意されている（2017年10月時点）．<code>dbi-store</code> は <a href="http://blog.8arrow.org">深町氏</a> の <a href="https://github.com/fukamachi/cl-dbi">Cl-DBI</a> を使ってSQLデータベースにセッションIDを保存するバックエンドだ．</p>
</div>
<div class="paragraph">
<p>ちなみにRedisはメモリ上にデータベースを構築するので，永続化するにはRDBファイルに定期的に書き出すか，更新差分のコマンドを記録するAOF（Append Only File）を書き出す必要がある（2017年10月現在）．</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>1つのLackアプリケーションにつき <code>store</code> インスタンスは1個だけ作成され，複数のWebリクエストで使われる．Webサーバーが複数スレッド（またはプロセス）を起動し，各スレッドでLackアプリケーションを立ち上げた場合，インメモリにセション情報を保持する <code>memory-store</code> 構造体を使用した場合，別スレッドで処理された過去のセッション情報にアクセスすることができない．Webリクエストを並列（並行）処理で捌く場合には，必ずデータベースか共有メモリを <code>store</code> バックエンドに指定しなければならないことに注意しよう．</p>
</div>
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_セッション状態定義の設定">セッション状態定義の設定</h3>
<div class="paragraph">
<p>次に，<a href="#listings:session-middleware-1">コード 1</a>の3行目，<code>:state</code> キーワードを見ていく．<code>state</code> キーワード変数には，セッションの状態を管理する <code>cookie-state</code> 構造体インスタンスが設定される．<code>cookie-state</code> 構造体は <code>state</code> 構造体を継承する．<code>state</code> 構造体はセッションIDの生成や状態管理を担い，<code>cookie-state</code> 構造体はクッキーに与える制約を設定する．まず，<code>state</code> 構造体の詳細を調べ，次に <code>cookie-state</code> 構造体を見ていく．</p>
</div>
<div class="paragraph">
<p><code>sate</code> 構造体は <a href="https://github.com/fukamachi/lack/blob/master/src/middleware/session/state.lisp"> <code>src/middleware/session/state.lisp</code> </a> で定義されている．<code>state</code> 構造体の定義を<a href="#listings:state-structure">コード 4</a>に掲げる．</p>
</div>
<div id="listings:state-structure" class="listingblock">
<div class="title">コード 4. <code>state</code> 構造体の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defstruct state
  (sid-generator (lambda (env)					<i class="conum" data-value="1"></i><b>(1)</b>
                   (declare (ignore env))
                   (generate-random-id)))
  (sid-validator (lambda (sid)
                   (not (null (ppcre:scan &#34;\\A[0-9a-f]{40}\\Z&#34; sid))))))

(defun generate-sid (state env)					<i class="conum" data-value="2"></i><b>(2)</b>
  (funcall (state-sid-generator state) env))

(defgeneric extract-sid (state env))				<i class="conum" data-value="3"></i><b>(3)</b>
(defmethod extract-sid :around ((state state) env)
  (let ((sid (call-next-method)))
    (when (and sid
               (funcall (state-sid-validator state) sid))
      sid)))

(defgeneric expire-state (state sid res options))		<i class="conum" data-value="4"></i><b>(4)</b>

(defgeneric finalize-state (state sid res options))		<i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>sid-generator</code> スロットにセッションIDを生成する関数を設定する．デフォルトの生成関数はこの後<a href="#listings:id-generation">コード 5</a>で詳しく見ていく．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sessionミドルウェアは <code>generate-sid</code> 関数を使ってセッションIDを生成するので，その際に <code>sid-generator</code> スロットの関数が起動される．デフォルトでは <a href="https://github.com/fukamachi/lack/blob/master/src/util.lisp"> <code>src/util.lisp</code> </a> 内で定義されている <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/util.lisp#L65"> <code>generate-random-id</code> </a> 関数でIDを生成する．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>state</code> 構造体インスタンスと環境変数 <code>env</code> から，セッションIDを抽出する総称関数を宣言．12—​16行目がその実装．<code>:around</code> 修飾子が付いているので，ユーザ実装のメソッドより前に12—​16行目のメソッドが実行される．この実装は <code>call-next-method</code> でユーザーによる実装を呼び出しセッションIDを取得し，妥当性を検査して返す．妥当でない場合は <code>nil</code> が返る．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>セッションを有効期限切れにして無効化する総称関数を宣言．<code>src/middleware/session/state/cookie.lisp</code> 内で実装されている（<a href="#listings:expire-state">コード 10</a>参照）．<code>src/middleware/session.lisp</code> 内から呼び出される（<a href="#listings:finalize">コード 8</a>の11行目）．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>セッションのfinalizeを担う総称関数を宣言．<code>src/middleware/session/state/cookie.lisp</code> 内で実装されている．同ファイル内と <code>src/middleware/session.lisp</code> 内から呼び出される．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><a href="#listings:state-structure">コード 4</a>の9行目で呼び出される <code>generate-random-id</code> の定義は以下のとおり．</p>
</div>
<div id="listings:id-generation" class="listingblock">
<div class="title">コード 5. デフォルトのセッションID生成関数</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defun generate-random-id ()
  &#34;Generates a random token.&#34;
  (byte-array-to-hex-string
   (digest-sequence
    (make-digest :SHA1)
    (ascii-string-to-byte-array
     (format nil &#34;~A~A&#34;
      (random 1.0) (get-universal-time))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>乱数とシステム・クロックの経過時間を繋げた文字列をキーに，SHA1ハッシュ関数でランダムな文字列を生成する．生成には <code>ironclad</code> パッケージの関数が使われている．</p>
</div>
<div class="paragraph">
<p>次に，<code>state</code> 構造体を継承した <code>cookie-state</code> 構造体を見てみよう．<code>cookie-state</code> 構造体は，クッキーに与える制約属性をスロットに保持する．以下のデフォルト設定を変更したい場合には，Sessionミドルウェアの <code>:state</code> 引数に独自設定の <code>cookie-state</code> インスタンスを渡せば良い．</p>
</div>
<div id="listings:id-cookie-state" class="listingblock">
<div class="title">コード 6. <code>cookie-state</code> 構造体の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defstruct (cookie-state (:include state))
  (path &#34;/&#34; :type string)						<i class="conum" data-value="1"></i><b>(1)</b>
  (domain nil :type (or string null))			<i class="conum" data-value="2"></i><b>(2)</b>
  (expires (get-universal-time) :type integer)	<i class="conum" data-value="3"></i><b>(3)</b>
  (secure nil :type boolean)	      			<i class="conum" data-value="4"></i><b>(4)</b>
  (httponly nil :type boolean)					<i class="conum" data-value="5"></i><b>(5)</b>
  (cookie-key &#34;lack.session&#34; :type string))		<i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Path属性．クライアントがクッキーをサーバーに送信できるサーバーのパスを指定する．デフォルト値はWebアプリのルートになる．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Domain属性．クライアントがクッキーを送信するサーバーのドメインは設定しない．この場合，クッキーを発行したサーバーのみが送信先になる．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Expires属性．クッキーの寿命を設定．デフォルト値は現在時刻になる．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Secure属性．デフォルトで設定されない．<code>t</code> に設定するとhttps接続以外ではクッキーを送信しなくなる．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>HttpOnly属性．デフォルトでは設定されない．<code>t</code> に設定するとJavaScriptからクッキーにアクセスできなくなる．</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>セッションIDを保持するクッキーのキー名を指定．デフォルト値は <code>&#34;lack.session&#34;</code>．リスポンスヘッダは <code>Set-Cookie: lack.session=セッションID</code> となる．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>以上がSessionミドルウェアの引数でデフォルトで渡される <code>cookie-state</code> 構造体インスタンスの中身である．デフォルト設定に関して幾つか注意点を挙げておく．</p>
</div>
<div class="paragraph">
<p>まずPath属性でWebアプリのルートディレクトリを指定しているため，Webアプリの全てのサブディレクトリに対するリクエストでクッキーが送信される．Path属性を指定しないと，クッキーが設定されたディレクトリ以外にはクッキーが送信されない．</p>
</div>
<div class="paragraph">
<p>Domain属性で <code>nil</code> が設定されているため，クッキーが設定されたホストだけにクッキーが送信され，サブドメインに対しても送信されない．www.host.comにもblog.host.comにもクッキーを送信したければDomain属性にhost.comを指定しなければならない．</p>
</div>
<div class="paragraph">
<p>Expires属性に現在時刻が設定されているため，クライアントが次にWebアプリにアクセスする時にはこのクッキーはサーバーに送信されない．</p>
</div>
<div class="admonitionblock note">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sessionミドルウェアを使用するアプリケーション側からはクッキー情報を保持する <code>cookie-state</code> 構造体インスタンスにアクセスする術がない．ミドルウェアとアプリケーションの間の情報のやり取りは <code>env</code> 環境変数を通してのみ行われるからだ（<a href="../app">「Lackアプリケーションを理解する」参照</a>）．従って，リクエストごとにクッキーの設定を変更することはできない．唯一変更できるのはExpires属性で，後で説明するように <code>env</code> 環境変数内に格納されている <code>:lack.session.options</code> を使って変更する．
</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="_keep_empty_引数"><code>keep-empty</code> 引数</h3>
<div class="paragraph">
<p>Sessionミドルウェアの最後の引数である <code>keep-empty</code> について見てみよう．<code>keep-empty</code> は <code>store</code> バックエンドにセッション変数を保存するか否かを指定するフラグである．<code>keep-empty</code> が <code>t</code> ならセッション変数は <code>store</code> に保存され，<code>nil</code> なら保存されない．</p>
</div>
<div class="paragraph">
<p><a href="#listings:main">コード 7</a>の20行目で <code>keep-empty</code> 引数が <code>t</code> だと24行目の <code>finalize</code> が呼び出される．<code>finalize</code> はセッション変数を <code>store</code> バックエンドに保存する役目と，ブラウザにクッキーを送信する役目を担う．クッキーが送信されるためにはさらに追加の条件が必要なので，<code>keep-empty</code> は <code>store</code> バックエンドにセッション変数を保存するか否かを決定するフラグになる．</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sessionミドルウェア本体">Sessionミドルウェア本体</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここまで長かったが，Sessionミドルウェアの引数を全て解明したので，いよいよミドルウェア本体の処理を見ていく．</p>
</div>
<div id="listings:main" class="listingblock">
<div class="title">コード 7. Sessionミドルウェア本体</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defparameter *lack-middleware-session*
  (lambda (app &amp;key
            (store (make-memory-store))
            (state (make-cookie-state))
            (keep-empty t))
    (lambda (env)
      (let* ((sid (extract-sid state env))
             (session (and sid
                           (fetch-session store sid)))
             (sid (or sid
                      (generate-sid state env)))
             (new-session-p (not session))
             (session (or session (make-hash-table :test &#39;equal))))
        (setf (getf env :lack.session) session)
        (setf (getf env :lack.session.options)
              (if new-session-p
                  (list :id sid :new-session t   :change-id nil :expire nil)
                  (list :id sid :new-session nil :change-id nil :expire nil)))
        (let ((res (funcall app env)))
          (if (and (not keep-empty)
                   new-session-p
                   (zerop (hash-table-count session)))
              res
              (finalize store state env res))))))
  &#34;Middleware for session management&#34;)</code></pre>
</div>
</div>
<div class="paragraph">
<p>6行目の <code>lambda</code> 式がミドルウェアチェーンの中で呼び出される．まず，7行目で環境 <code>env</code> からセッションIDを取り出す．もしセッションIDを既に持っているなら <code>store</code> からセッション変数を取り出し <code>session</code> に代入する（9行目）．ここで取り出されたセッション変数はハッシュテーブルで，セッション毎に保存しておきたい値を自由に格納できる．10行目ではセッションIDが割り当てられていない新規セッションに向けて新たなセッションIDを生成し <code>sid</code> に代入する．この時点で，新規・既存いずれのセッションにおいても <code>sid</code> にセッションIDが格納されていることになる．12行目ではセッション変数が設定されているか否かで，新規セッションか否かを表す述語変数 <code>new-session-p</code> を設定する．新規セッションならば13行目で <code>session</code> に新しいハッシュテーブルが設定される．この時点で新規・既存セッションを問わず <code>session</code> ローカル変数も設定が完了する．</p>
</div>
<div class="paragraph">
<p>14行目で <code>env</code> 環境変数（ハッシュテーブル）に <code>:lack.session</code> をキーにセッション変数を代入する．既存セッションには無駄な処理のように見える．</p>
</div>
<div class="paragraph">
<p>15行では，<code>env</code> に <code>:lack.session.options</code> をキーにオプションリストを設定する．ここでは，新規セッション時にのみ <code>:new-session</code> キーを <code>t</code> に設定し，他のオプションをデフォルト設定に戻している．デフォルトでは（<code>:change-id nil</code>）と <code>:expire</code> を `nil`に設定している．</p>
</div>
<div class="paragraph">
<p>ミドルウェア・チェーンの後段が19行目の <code>(funcall app env)</code> で呼び出されるが，その中で <code>:change-id</code> を <code>t</code> に設定すれば，24行目の <code>(finalize store state env res)</code> 内で新しいセッションIDが生成される．ログイン時には必ずセッションIDを更新することが <a href="https://www.ipa.go.jp/security/vuln/websecurity.html">IPAの「安全なウェブサイトの作り方」</a> でも推奨されているので，その場合には後で示す <a href="#sec-example3">サンプルアプリ（例３）</a> ように後段のミドルウェアで <code>:change-id</code> を <code>t</code> に設定する．</p>
</div>
<div class="paragraph">
<p><code>:expire</code> オプションはログアウト時など即座にセッションを切りたい時に使うフラグで，<code>:expire</code> を <code>t</code> に設定すると<a href="#listings:finalize">コード 8</a>の10—​11行目でセッションをexpireする処理が実行される．ちなみに，スペルが1文字違いの <code>:expires</code> オプションが別途あるので注意を要する．<code>:expires</code> オプションはクッキーの有効期間を秒数で指定するものである（後ほど説明）．</p>
</div>
<div class="paragraph">
<p>これらオプションを変更するには，Sessionミドルウェアより後のミドルウェアチェーンの事前または事後処理で <code>env</code> から <code>:lack.session.options</code> キーの値を取り出して上書きする．これらオプションはSessionミドルウェア事後処理の <code>finaize</code> や <code>finalize-state</code> 関数（<a href="#listings:finalize-state">コード 11</a>を参照）で使用される．</p>
</div>
<div class="paragraph">
<p>19行目でミドルウェアチェーンの次のアプリケーションを呼び出し，結果を <code>res</code> に代入する．20行目以降が事後処理である．</p>
</div>
<div class="paragraph">
<p>事後処理は，<code>keep-empty</code> が <code>nil</code> で且つ，新規セッション且つ，セッション変数が空なら，何もせずに <code>res</code> を返し，それ以外はファイナライズ処理を行う．</p>
</div>
<div class="paragraph">
<p>24行目の <code>finalize</code> 関数の定義は同じファイル内にある．<code>finalize</code> の役割は前にも説明した通り，セッション変数を <code>store</code> バックエンドに保存する役目と，ブラウザにクッキーを送信する役目を担う．</p>
</div>
<div id="listings:finalize" class="listingblock">
<div class="title">コード 8. <code>finaize</code> 関数の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defun finalize (store state env res)
  (let* ((session (getf env :lack.session))
         (options (getf env :lack.session.options))
         (id (getf options :id))
         (new-id (if (getf options :change-id)
                     (generate-sid state env)
                     id)))
    (when session
      (apply #&#39;commit store new-id session options))
    (if (getf options :expire)
        (expire-state state id res options)
        (finalize-state state new-id res options))))</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#listings:finalize">コード 8</a>の8—​9行目で，<code>store</code> バックエンドにセッション変数が保存される．<code>commit</code> 関数は同じファイル内で<a href="#listings:commit">コード 9</a>のように定義されている．</p>
</div>
<div class="paragraph">
<p><a href="#listings:finalize">コード 8</a>の10行目では <code>:expire</code> オプションが <code>t</code> の時に <code>expire-state</code> 関数を呼び出して直ちにセッションを切る処理をしている．<code>expire-state</code> は<a href="#listings:expire-state">コード 10</a>に定義されているように，クッキーの有効期間（秒数）を保持する <code>:expires</code> オプションを0に設定することで直ちにセッションを無効化している．</p>
</div>
<div id="listings:commit" class="listingblock">
<div class="title">コード 9. <code>commit</code> 関数の定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defun commit (store new-sid session &amp;key id expire change-id &amp;allow-other-keys)
  (cond
    (expire
     (remove-session store id))
    (change-id
     (remove-session store id)
     (store-session store new-sid session))
    (t
     (store-session store id session))))</code></pre>
</div>
</div>
<div id="listings:expire-state" class="listingblock">
<div class="title">コード 10. <code>expire-state</code> メソッドの定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defmethod expire-state ((state cookie-state) sid res options)
  (setf (getf options :expires) 0)
  (finalize-state state sid res options))</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#listings:finalize">コード 8</a>の最後で呼び出される <code>finalize-state</code> は総称関数で，<code>:expire</code> オプションが <code>nil</code> の時に呼び出され <a href="https://github.com/fukamachi/lack/blob/19b9f1baa3503b79d68378d70bcd1632eb99de87/src/middleware/session/state/cookie.lisp#L38"> <code>src/middleware/session/state/cookie.lisp</code> </a> で2つの実装が定義されている．引数の <code>state</code> 変数には <code>cookie-state</code> 構造体インスタンスが渡される．1つ目の実装（<a href="#listings:finalize-state">コード 11</a>，1—​4行目）は，<code>res</code> 引数が関数の場合，すなわち，別のミドルウェアかアプリケーションの場合に呼び出される．この場合は，この関数を実行して実際のレスポンスを生成する．最終的なレスポンスは「ステータス・コード，ヘッダ，レスポンス・ボディ」の3つの要素から成るリストになる．この場合は，<a href="#listings:finalize-state">コード 11</a>の6行目以降で定義されている実装が事後処理として呼び出される．</p>
</div>
<div id="listings:finalize-state" class="listingblock">
<div class="title">コード 11. <code>finalize-state</code> メソッドの定義</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defmethod finalize-state ((state cookie-state) sid (res function) options)
  (lambda (responder)
    (funcall res (lambda (actual-res)
                   (funcall responder (finalize-state state sid actual-res options))))))

(defmethod finalize-state ((state cookie-state) sid (res list) options)  <i class="conum" data-value="1"></i><b>(1)</b>
  ;; Don&#39;t send Set-Cookie header when it&#39;s not necessary.
  (destructuring-bind (&amp;key no-store new-session change-id expire &amp;allow-other-keys)
      options
    (when (or no-store
              (not (or new-session change-id expire)))
      (return-from finalize-state res)))               <i class="conum" data-value="2"></i><b>(2)</b>

  (let ((res (apply #&#39;make-response res))                         <i class="conum" data-value="3"></i><b>(3)</b>
        (options (with-slots (path domain expires secure httponly) state  <i class="conum" data-value="4"></i><b>(4)</b>
                   (list :path path
                         :domain domain
                         :secure secure
                         :httponly httponly
                         :expires (+ (get-universal-time)
                                     (getf options :expires expires)))))) <i class="conum" data-value="5"></i><b>(5)</b>
    (setf (getf (response-set-cookies res) (cookie-state-cookie-key state))
          `(:value ,sid ,@options))
    (finalize-response res)))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>この時点で引数の <code>options</code> には，<code>env</code> から取り出した <code>lack.session.options</code> のplistがコピーされている．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>no-store</code> オプションが <code>t</code> か，または，新規セッション，セッションIDの変更，クッキーの期限切れのいずれでもなければ（いずれも <code>nil</code> ならば），クッキーはブラウザに送信されず直ちにレスポンスを返る．ちなみに <code>no-store</code> オプションはデフォルトでは設定されないオプションなので，Webアプリの方でクッキーを送信したくない時に使用する．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>これ以降は更新したクッキーヘッダをレスポンスオブジェクトに含める処理をする．</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>現在のクッキー情報を格納する <code>state</code> から <code>path</code>, <code>domain</code>, <code>expires</code>, <code>secure</code>, <code>httponly</code> を取り出し，<code>options</code> に設定する．この <code>options</code> が次に送信されるクッキーの設定（22—​23行目）に使われる．</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>getf</code> で <code>:expires</code> プロパティの値を取り出す元となる <code>options</code> は <code>env</code> から取り出された <code>lack.session.options</code> のplistのコピー．<code>options</code> 内に <code>:expires</code> プロパティがなければ15行目で <code>cookie-state</code> インスタンスの <code>expires</code> スロットから取り出した値が有効期間となる．ここで指定された秒数は24行目の <code>finalize-response</code> を通して適切な文字列フォーマットに変換される（ <a href="https://github.com/fukamachi/lack/blob/c8b6b003d403811f37dbc5bed734b9f9d378e5b3/src/response.lisp#L57"><code>bake-cookie</code></a> 参照）．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p><code>finalize-state</code> は<a href="#listings:finalize-state">コード 11</a>の10行目の条件が成立しない時，クッキーをブラウザに送信する．すなわち，<code>env</code> 内の <code>:lack.session.options</code> で，<code>:no-store</code> オプションが <code>nil</code> で且つ，<code>:new-session</code>，<code>:change-id</code>，<code>:expire</code> オプション値の全てが <code>nil</code> の場合にクッキーが送信される．</p>
</div>
<div class="paragraph">
<p><code>:expires</code> オプションはセッション有効期間を秒数で指定するもので，直ちにセッションを無効化する <code>:expire</code> オプションとは異なるので注意．次のリクエストが <code>:expires</code> で指定された秒数を超えた場合にはクッキーに保存されたセッション情報が無効になりセッションが切れる．</p>
</div>
<div class="paragraph">
<p>最終アクセスから <code>:expires</code> 秒後にセッションを無効化したい場合，<code>:expires</code> の指定だけでは不十分で，<code>new-session</code> か <code>change-id</code> のいずれかを <code>t</code> に設定する必要がある．なぜなら，これらが <code>nil</code> のとき<a href="#listings:finalize-state">コード 11</a>の12行目が実行され，クッキーのExpire属性が更新されずにリクエストを返してしまうからである．<code>new-session</code> と <code>change-id</code> を <code>t</code> に設定せずに <code>:expires</code> だけ設定した場合には，最初のアクセスから <code>:expires</code> 秒後にセッションが切れることになる．</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sec:sample">サンプルコード</h2>
<div class="sectionbody">
<div class="paragraph">
<p>ここではSessionミドルウェアを使った3つのサンプルアプリを示す．1つ目はデフォルト設定，2つ目は <code>:expires</code> オプションを使って最終アクセスから5秒後にセッションが切れる設定，3つ目はログイン・ログアウトを実現するアプリである．</p>
</div>
<div class="sect2">
<h3 id="_例1デフォルト設定のサンプルアプリ">例1）デフォルト設定のサンプル・アプリ</h3>
<div class="paragraph">
<p><a href="#listings:default">コード 12</a>はデフォルト設定のままSessionミドルウェアを使ったサンプル・アプリで，Sessionミドルウェアの設定以外は例2と同じものになる（ <a href="https://github.com/wshito/blog-examples/blob/master/lisp/lack/middleware-session-default.lisp"><code>middleware-session-default.lisp</code></a> on GitHub ）．</p>
</div>
<div class="paragraph">
<p>サンプルアプリの実行方法を説明しておく．<a href="#listings:default">コード 12</a>をREPLで評価するとHunchentootサーバーが起動する．REPL上のメッセージに従ってブラウザで <a href="http://localhost:5000">http://localhost:5000</a> にアクセスする．サーバーを終了するには，<a href="#listings:default">コード 12</a>の最終行でコメントアウトされている <code>(clack:stop *handler*)</code> をREPLで評価する．<a href="#sec-example2">（例2）</a>，<a href="#sec-example3">（例3）</a>の実行方法も同様である．</p>
</div>
<div id="listings:default" class="listingblock">
<div class="title">コード 12. デフォルト設定のサンプル・アプリ</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(require &#39;clack)
(require &#39;lack)

(defparameter *subtitle* &#34;&lt;h2&gt;--- With Default Settings ---&lt;/h2&gt;&#34;)

;; information to extract from :lack.session.options from env
(defparameter *options*
  (list :new-session :change-id :no-store :expire :expires))

;;
;; Echos session info
;;
(defparameter *my-echo*
      (lambda (env)
	(let* ((session (getf env :lack.session))
	       (counter (gethash :visit session -1)))
	  (setf (gethash :visit session) (incf counter))
	  `(200 (:content-type &#34;text/html&#34;)
		,(append
		  (list &#34;&lt;html&gt;&lt;h1&gt;Lack Session Middleware Test&lt;/h1&gt;&#34;
			*subtitle*
			&#34;&lt;ul&gt;&#34;
			(format nil &#34;&lt;li&gt;Visiting times: ~A&lt;/li&gt;&#34; counter))
		  (mapcar (lambda (key)
			    (let ((val (getf (getf env :lack.session.options)
					     key)))
			      (format nil &#34;&lt;li&gt;~A = ~A&lt;/li&gt;&#34; key val)))
			  *options*)
		  (list &#34;&lt;/ul&gt;&lt;/html&gt;&#34;))))))
;;
;; Creates Lack Application
;;
(defparameter *app*
  (lack:builder
   :session
   *my-echo*))

;;
;; Starts the Web server
;;
(defparameter *handler*
  (clack:clackup *app*))

;;
;; Stops the Web server
;;
; (clack:stop *handler*)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sec-example2">例2） <code>:expires</code> オプションを使い最終アクセスから5秒後にセッションを切るアプリ</h3>
<div class="paragraph">
<p>例1）の <code>*my-echo*</code> を以下のように変更する．ここでは変更部分のみ示すので全ソースコードは <a href="https://github.com/wshito/blog-examples/blob/master/lisp/lack/middleware-session-expire.lisp">こちら（GitHub）</a> を参照されたい．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defparameter *my-echo*
  (lambda (env)
	(let* ((session (getf env :lack.session))
	       (counter (gethash :visit session -1)))
	  (setf (gethash :visit session) (incf counter))
	  ;; expires after 5 seconds since the last acess
	  (setf (getf (getf env :lack.session.options) :expires) 5)     <i class="conum" data-value="1"></i><b>(1)</b>
	  (setf (getf (getf env :lack.session.options) :new-session) t) <i class="conum" data-value="2"></i><b>(2)</b>
	  `(200 (:content-type &#34;text/html&#34;)
		,(append
		  (list &#34;&lt;html&gt;&lt;h1&gt;Lack Session Middleware Test&lt;/h1&gt;&#34;
			*subtitle*
			&#34;&lt;ul&gt;&#34;
			(format nil &#34;&lt;li&gt;Visiting times: ~A&lt;/li&gt;&#34; counter))
		  (mapcar (lambda (key)
			    (let ((val (getf (getf env :lack.session.options)
					     key)))
			      (format nil &#34;&lt;li&gt;~A = ~A&lt;/li&gt;&#34; key val)))
			  *options*)
		  (list &#34;&lt;/ul&gt;&lt;/html&gt;&#34;))))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>env</code> プロパティ・リストから <code>:lack.session.options</code> プロパティ・リストを取り出し，<code>:expires</code> プロパティの値を5に設定．これでクッキーのExpires属性が5秒に設定される．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>さらに同オプションの <code>:new-session</code> プロパティの値を <code>t</code> に設定することで，クッキーヘッダがブラウザに送信され更新される．これを忘れるとセッションが切れないので注意．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>Lispの変数は全て参照渡し（ポインタのコピー）なので，<code>:lack.session.options</code> に格納されているプロパティ・リストへのポインタを<a href="#listings:wrong-example">コード 13</a>の様に，一旦 <code>op</code> に格納し，上の7—​8行目のプロパティ・リストの取り出しを1回で済ませようとすると，<code>:expires</code> の設定が反映されないので注意を要する．</p>
</div>
<div id="listings:wrong-example" class="listingblock">
<div class="title">コード 13. 誤った設定例</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">  (lambda (env)
	(let* ((session (getf env :lack.session))
	       (counter (gethash :visit session -1))
	       (op (getf env :lack.session.options)))  ;; ローカル変数にenv内のoptionsをバインド
	  ;; expires after 5 seconds since the last acess
	  (setf (getf op :expires) 5)  ;;  (setf (getf (getf env :lack.session.options) :expires) 5)</code></pre>
</div>
</div>
<div class="paragraph">
<p>なぜ反映されないかというと，プロパティ・リストに <code>setf</code> で破壊的に代入を試みても，リスト内にキーが無い場合，新しいキーと値からなるコンスセルがプロパティ・リストの先頭に追加され，<code>env</code> 内の <code>:lack.session.options</code> は相変わらず古いリストへのポインタ（新しいリストの2番目のコンスセルを指すポインタ）を保持しているからだ．</p>
</div>
<div class="admonitionblock warning">
<table>
<tbody><tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>以下は，それぞれの <code>setf</code> の呼び出し方の違いがどのように処理されるかを自分自身の覚書として記録したもので，<a href="#sec-example3">例3</a>まで飛ばして頂いて問題ない．</p>
</div>
</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>プロパティ・リストに対する <code>setf</code> で使われる <a href="https://github.com/sbcl/sbcl/blob/66b93f57c23141c132d297d23161c857dc47df2a/src/code/symbol.lisp#L403"><code>SB-IMPL::%PUTF</code></a> の定義は以下のとおり（以下SBCLの場合）．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defun %putf (place property new-value)
  (declare (type list place))
  (do ((plist place (cddr plist)))
      ((endp plist) (list* property new-value place)) <i class="conum" data-value="1"></i><b>(1)</b>
    (declare (type list plist))
    (when (eq (car plist) property)
      (setf (cadr plist) new-value)
      (return place))))                               <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>property</code> が見つからないときは，<code>property</code> と <code>new-value</code> を先頭要素に加えたリストを返す．つまり返されたリストを指すポインタは元の <code>place</code> とは異なるアドレスを指す．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>見つかったときは <code>place</code>，すなわち元のプロパティ・リストを返す．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>まず <code>DO</code> ループの定義は，</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(do ((var init-form step-form)*)
    (end-test-form result-form*)
    statement*)</code></pre>
</div>
</div>
<div class="paragraph">
<p>そして，<code>endp</code> は引数が空リストのとき真で，コンスのとき偽を返す．</p>
</div>
<div id="listings:proper-setf-usage" class="listingblock">
<div class="title">コード 14. <code>:lack.session.options</code> を設定する時の注意</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">CL-USER&gt; (macroexpand &#39;(setf (getf (getf env :lack.session.options) :expires) 5))
(LET* ((#:NEW624 5))     <i class="conum" data-value="1"></i><b>(1)</b>
  (LET ((#:NEW623
         (SB-IMPL::%PUTF (GETF ENV :LACK.SESSION.OPTIONS NIL) :EXPIRES
                         #:NEW624)))  <i class="conum" data-value="2"></i><b>(2)</b>
    (LET ((#:NEW1 (SB-IMPL::%PUTF ENV :LACK.SESSION.OPTIONS #:NEW623)))  <i class="conum" data-value="3"></i><b>(3)</b>
      (SETQ ENV #:NEW1)
      #:NEW623)
    #:NEW624))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>引数が1回だけ評価されることを保証するために <code>:expire</code> プロパティに設定する値を一時変数 <code>#:NEW624</code> に保存．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>SB-IMPL::%PUTF</code> 関数は <code>ENV</code> から取り出した <code>:LACK.SESSION.OPTIONS</code> の値（この場合プロパティ・リスト）から <code>:expire</code> プロパティを探し，見つかればその場所に5を破壊的に代入しプロパティ・リストへのポインタを返す．見つからなければ，元のプロパティ・リストの先頭に <code>:expire 5</code> を追加し連結後のリストを返す．ただし，後ろに連結されたリストはメモリ上では元のリストと同じオブジェクトである．</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>上の &lt;2&gt; で代入後のリストを元の <code>ENV</code> の <code>:LACK.SEESION.OPTIONS</code> の値に設定する．上の &lt;2&gt; で <code>:expire</code> が見つからなかった場合には，この時点で <code>:LACK.SEESION.OPTIONS</code> の値は新しいリストへのをポインタに変更されている．</td>
</tr>
</tbody></table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">CL-USER&gt; (macroexpand &#39;(setf (getf op :expires) 5))
(LET* ((#:NEW625 5))
  (LET ((#:NEW1 (SB-IMPL::%PUTF OP :EXPIRES #:NEW625)))  <i class="conum" data-value="1"></i><b>(1)</b>
    (SETQ OP #:NEW1)  <i class="conum" data-value="2"></i><b>(2)</b>
    #:NEW625))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ここまでは，<a href="#listings:proper-setf-usage">コード 14</a>と同じ．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ここで，<code>:expires</code> プロパティが見つからなかった時に新しいリストに変更されているが，一時変数 <code>OP</code> にそのリストへのポインタが設定されるだけで，<code>ENV</code> ないの <code>:LACK.SESSION.OPTIONS</code> プロパティの値は変更されない．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>一方，ハッシュテーブルの場合は，キーが見つからずに新規にキー・バリューが設定されても，ハッシュテーブル・オブジェクト自身のアドレスは変更されないので，問題ない．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">CL-USER&gt; (macroexpand &#39;(setf (gethash :visit session) (incf counter)))
(LET* ((#:HASHTABLE SESSION)     <i class="conum" data-value="1"></i><b>(1)</b>
      	　(#:NEW1 (INCF COUNTER)))
  (SB-KERNEL:%PUTHASH :VISIT #:HASHTABLE #:NEW1))  <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>引数の <code>session</code> の値（ハッシュテーブルへのポインタ）が一時変数 <code>#:HASHTABLE</code> に設定される．</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>#:HASHTABLE</code> と <code>session</code> は同じハッシュテーブルを指すので，ここで <code>#:NEW1</code> の値を設定すれば，元の <code>session</code> 変数の中身も変わる．</td>
</tr>
</tbody></table>
</div>
</div>
<div class="sect2">
<h3 id="sec-example3">例3）ログイン・ログアウトの実装</h3>
<div class="paragraph">
<p>特定のディレクトリ以下のアクセスにはログインを強要するWebアプリの例を示す．それ以外のディレクトリは自由にアクセスできる．</p>
</div>
<div class="paragraph">
<p>ここでは要所要所の解説のみを示すので，全ソースコードは <a href="https://github.com/wshito/blog-examples/blob/master/lisp/lack/middleware-session-logout.lisp">こちら（GitHub）</a> を参照されたい．</p>
</div>
<div class="paragraph">
<p>アプリケーションは <code>lack:builder</code> を使って構築している．</p>
</div>
<div id="listings:app-builder" class="listingblock">
<div class="title">コード 15. アプリケーション構成</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defparameter *app*
  (lack:builder
   :session
   (secure-mw #&#39;redirect-to-login-page &#39;(&#34;/private&#34;))
   (:mount &#34;/login&#34; *login*)
   (:mount &#34;/auth&#34; *auth*)
   (:mount &#34;/logout&#34; *logout*)
   (:mount &#34;/private&#34; *private*)
   *sample-app*))</code></pre>
</div>
</div>
<div class="paragraph">
<p>ミドルウェア・チェーンの先頭は <code>:session</code> ミドルウェアでセッション変数の管理を移譲する（<a href="#listings:app-builder">コード 15</a>，3行目）．次の <code>secure-mw</code> が独自実装のミドルウェアで定義は<a href="#listings:secure-mw">コード 16</a>の通りである．<code>secure-mw</code> は，特定のパス以下にアクセスする場合にログインを要求するミドルウェアである．すでにログイン済みの場合は，ミドルウェア・チェーンの後段に処理を渡す．</p>
</div>
<div id="listings:secure-mw" class="listingblock">
<div class="title">コード 16. セキュア領域を守るミドルウェア</div>
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">;;; Middleware to proctect the secure area
;;; :uidが設定されていない場合，protected-pathにアクセスすると
;;; redirect関数を呼び出してログインページへリダイレクトする．
(defun secure-mw (redirect protected-path)
  (lambda (app)
    (lambda (env)
      ;; preprocessing
      (let* ((url (getf env :path-info))
             (session (getf env :lack.session))
             (uid (gethash :uid session)))
        (if (and (null uid)
                 (dolist (prefix protected-path)
                        (when (starts-with url prefix) (return t))))
            (progn
              ;;当初のアクセス先をセッション変数に保存
              (setf (gethash :prev-url session) url)
              (funcall redirect))
            (funcall app env))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="#listings:secure-mw">コード 16</a>の17行目でログインページへリダイレクトする前に，現在のアクセス先URLをセッション変数に保存している．ログインに成功した時には，セッション変数からこのURLを取り出し，元のページへリダイレクトする．</p>
</div>
<div class="paragraph">
<p>ログインページへのリダイレクトを担う関数は<a href="#listings:app-builder">コード 15</a>の4行目で指定された <code>redirect-to-login-page</code> 関数で，以下のように定義されている．</p>
</div>
<div class="listingblock">
<div class="title">コード 17. リダイレクト</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">;;; ログインページへリダイレクトするレスポンスを返す．
(defun redirect-to-login-page ()
  &#39;(303 (:location &#34;/login&#34;) (&#34;&#34;)))</code></pre>
</div>
</div>
<div class="paragraph">
<p>ログインページの定義は以下の通りで，セッション変数内に <code>uid</code> が設定されていればログイン済みメッセージを表示し，設定されていなければログインフォームを表示する．</p>
</div>
<div class="listingblock">
<div class="title">コード 18. ログインページ</div>
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defparameter *login*
  (lambda (env)
    (let ((uid (get-uid env)))
      `(200 (:content-type &#34;text/html&#34;)
            ,(append (page-header)
                     (if uid
                         (list &#34;&lt;p&gt;You are already logged in as &#34; uid &#34;.&lt;/p&gt;&#34;)
                         (login-form))
                     (page-footer))))))</code></pre>
</div>
</div>
<div class="paragraph">
<p>ログインフォームは，「パラメータと値」をドット対のリストに格納し，POSTメソッドのbodyとして送信してくる．ログインフォームは <code>/auth</code> にマウントしている以下のアプリケーションを呼び出す．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp line-numbers" data-lang="lisp line-numbers">(defparameter *auth*
  (lambda (env)
    (let* ((params (getf env :body-parameters))
           (name (cdr (assoc &#34;uname&#34; params :test #&#39;string=)))
           (pass (cdr (assoc &#34;passwd&#34; params :test #&#39;string=))))
      (if (and (= (length params) 2)
               (authenticate name pass))
          (let* ((session (getf env :lack.session))
                 (url (gethash :prev-url session &#34;/&#34;)))
            (setf (gethash :uid session &#34;/&#34;) name)
            (setf (getf (getf env :lack.session.options) :change-id) t) <i class="conum" data-value="1"></i><b>(1)</b>
            `(303 (:location ,url) (&#34;&#34;)))
          (redirect-to-login-page)))))</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tbody><tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ログイン後は新しいセッションIDを割り当てる．次回アクセス時には <code>:change-id</code> の値は <code>nil</code> にリセットされるため，セッションIDの更新は1回限りである．</td>
</tr>
</tbody></table>
</div>
<div class="paragraph">
<p>認証自体は <code>authenticate</code> 関数に委譲し，成功すればセッション変数から <code>:prev-url</code> に保存されている当初のアクセス先を取り出しリダイレクトする．失敗すればログインページへリダイレクトする．セッションの乗っ取りを避けるためにログイン時に新たなセッションIDを割り当てる設定をする（11行目）．</p>
</div>
<div class="paragraph">
<p>ログアウトは，<code>:lack.session.options</code> の <code>:expire</code> キーの値を <code>t</code> に設定することで実現する．</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-lisp" data-lang="lisp">(defparameter *logout*
  (lambda (env)
    (setf (getf (getf env :lack.session.options) :expire) t)
    `(200 (:content-type &#34;text/html&#34;)
          ,(append (page-header)
                   (list &#34;&lt;p&gt;You have logged out.&lt;/p&gt;&#34;)
                   (page-footer)))))</code></pre>
</div>
</div>
</div>
</div>
</div>

              </section>


              <footer class="post-footer">


                









<section class="author">
  <h4><a href="http://diary.wshito.com/">wshito</a></h4>
  
  <p>Read <a href="http://diary.wshito.com/">more posts</a> by this author.</p>
  
  <div class="author-meta">
    <span class="author-location icon-location">Itoshima, Japan</span>
    <span class="author-link icon-link"><a href="http://diary.wshito.com">http://diary.wshito.com</a></span>
  </div>
</section>




                
<section class="share">
  <h4>Share this post</h4>
  <a class="icon-twitter" href="https://twitter.com/share?text=%e3%82%b3%e3%83%bc%e3%83%89%e3%83%aa%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0%3a%20Lack%20%e3%81%ae%20Session%20%e3%83%9f%e3%83%89%e3%83%ab%e3%82%a6%e3%82%a7%e3%82%a2%e3%82%92%e7%90%86%e8%a7%a3%e3%81%99%e3%82%8b&nbsp;-&nbsp;wshito%27s%20diary&amp;url=http%3a%2f%2fdiary.wshito.com%2fcomp%2flisp%2fclack%2flack-middleware-session%2f"
      onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
      <span class="hidden">Twitter</span>
  </a>
  <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fdiary.wshito.com%2fcomp%2flisp%2fclack%2flack-middleware-session%2f"
      onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
      <span class="hidden">Facebook</span>
  </a>
  <a class="icon-google-plus" href="https://plus.google.com/share?url=http%3a%2f%2fdiary.wshito.com%2fcomp%2flisp%2fclack%2flack-middleware-session%2f"
     onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
      <span class="hidden">Google+</span>
  </a>
</section>



                





              </footer>
            </article>

          </main>

          
          <aside class="read-next">
  
  <a class="read-next-story no-cover" style="no-cover" href="http://diary.wshito.com/comp/lisp/sequence/">
          <section class="post">
              <h2>Lisp の Sequence 型のまとめ</h2>
              
          </section>
      </a>
  
  
      <a class="read-next-story prev no-cover" style="no-cover" href="http://diary.wshito.com/comp/lisp/ros-local/">
          <section class="post">
              <h2>Roswell 環境下でのローカル・プロジェクト管理入門</h2>
          </section>
      </a>
  
</aside>

          

              <footer class="site-footer clearfix">
        <section class="copyright"><a href="">wshito&#39;s diary</a> All rights reserved 2016--</section>
        
        <section class="poweredby">Proudly generated by <a class="icon-hugo" href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme</section>
        
    </footer>
    </div>
    <script type="text/javascript" src="http://diary.wshito.com/js/jquery.js"></script>
    <script type="text/javascript" src="http://diary.wshito.com/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="http://diary.wshito.com/js/index.js"></script>
    <script type="text/javascript" src="http://diary.wshito.com/js/prism.js"></script>
    <script type="text/javascript" src="http://diary.wshito.com/js/toc.js"></script>
    <script type="text/x-mathjax-config">
     MathJax.Hub.Config({
       TeX: {
	 extensions: ["AMSmath.js", "AMSsymbols.js"]
       }
     });
    </script>
    <script type="text/javascript" async
	    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML">
    </script>
    
</body>
</html>
